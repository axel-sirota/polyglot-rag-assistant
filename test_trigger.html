<!DOCTYPE html>
<html>
<head>
    <title>LiveKit Agent Trigger Test</title>
    <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.min.js"></script>
</head>
<body>
    <h1>LiveKit Agent Test</h1>
    <button onclick="connectWithAgent()">Connect & Request Agent</button>
    <div id="status"></div>
    
    <script>
        async function connectWithAgent() {
            const status = document.getElementById('status');
            status.innerHTML = 'Connecting...';
            
            const room = new LivekitClient.Room();
            
            // Add event listeners
            room.on('participantConnected', (participant) => {
                console.log('Participant connected:', participant.identity);
                if (participant.identity.startsWith('agent-')) {
                    status.innerHTML += '<br>âœ… AGENT JOINED: ' + participant.identity;
                }
            });
            
            room.on('trackSubscribed', (track, publication, participant) => {
                if (track.kind === 'audio' && participant.identity.startsWith('agent-')) {
                    status.innerHTML += '<br>ðŸ”Š Agent audio track subscribed!';
                    const audioElement = track.attach();
                    document.body.appendChild(audioElement);
                }
            });
            
            try {
                // Get token - you need to generate this with your API
                // For testing, you can generate one at https://cloud.livekit.io/projects/YOUR_PROJECT/playground
                const token = prompt('Enter your LiveKit token:');
                if (!token) {
                    status.innerHTML = 'Token required';
                    return;
                }
                
                // Connect with agent request metadata
                await room.connect(
                    'wss://polyglot-rag-assistant-3l6xagej.livekit.cloud',
                    token,
                    {
                        autoSubscribe: true,
                        publishDefaults: {
                            audioBitrate: 64000,
                            dtx: true
                        }
                    }
                );
                
                // IMPORTANT: Set metadata after connecting to trigger agent
                await room.localParticipant.setMetadata(JSON.stringify({ 
                    agent_request: true 
                }));
                status.innerHTML += '<br>Connected! Waiting for agent...';
            } catch (error) {
                status.innerHTML = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>